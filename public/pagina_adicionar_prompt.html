<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Adicionar ou Editar Prompt</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h2 class="mb-4 text-center">Adicionar ou Editar Prompt</h2>

    <div class="mb-3">
      <label for="tituloSelecionado" class="form-label">Selecionar Título Existente</label>
      <select id="tituloSelecionado" class="form-select">
        <option value="">-- Escolha um título para editar --</option>
      </select>
    </div>

    <form id="promptForm" class="bg-white p-4 rounded shadow">
      <div class="row mb-3">
        <div class="col-md-6">
          <button type="submit" class="btn btn-primary">Salvar Prompt</button>
          <button type="button" id="btnExcluir" class="btn btn-danger" disabled>Excluir Prompt</button>
          <a href="index.html" class="btn btn-outline-secondary">Voltar para a Galeria</a>
        </div>
      </div>
      <!-- Corrige o erro de digitação e separa em duas colunas -->
      <div class="row mb-3">
        <div class="col-md-6">
          <label for="titulo" class="form-label">Título</label>
          <input type="text" class="form-control" id="titulo" required>
        </div>
        <div class="col-md-6">
          <label for="tags" class="form-label">Tags (separadas por vírgula)</label>
          <input type="text" class="form-control" id="tags" required>
        </div>
      </div>


      <div class="mb-3">
        <label for="descricao" class="form-label">Descrição</label>
        <textarea class="form-control" id="descricao" rows="20" required></textarea>
      </div>

    </form>


    <div id="mensagem" class="text-center mt-3"></div>

  </div>

  <script>
    let promptsMap = {};

      function getQueryParam(name) {
    const q = new URLSearchParams(window.location.search);
    return q.get(name);
  }

  function selecionarTituloNoCombo(tituloParam) {
    if (!tituloParam) return;
    const select = document.getElementById('tituloSelecionado');
    const alvo = tituloParam.trim().toLowerCase();
    let foundValue = '';

    for (const opt of select.options) {
      if (opt.value.trim().toLowerCase() === alvo) {
        foundValue = opt.value;
        break;
      }
    }

    if (foundValue) {
      // se existir no combo, seleciona e dispara change para preencher os campos
      select.value = foundValue;
      select.dispatchEvent(new Event('change'));
    } else {
      // se não existir no combo, pelo menos preenche o input de título
      const inputTitulo = document.getElementById('titulo');
      if (inputTitulo) inputTitulo.value = tituloParam;
    }
  }

    // Parser robusto, aceita linhas em branco na descrição, aceita espaços e BOM, separa por marcadores
    function parseTextoPrompts(texto) {
      let t = String(texto || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      t = t.replace(/^\uFEFF/, '').trim();

      // Flags g m i, início de linha para Título, aceita linhas em branco entre blocos
      const re = /^\s*Título:\s*([^\n]+)\n\s*Descrição:\s*([\s\S]*?)\n\s*Tags:\s*([^\n]*?)\s*(?=\n\s*\n\s*^Título:|\s*$)/gmi;

      const arr = [];
      let m;
      while ((m = re.exec(t)) !== null) {
        arr.push({
          titulo: (m[1] || '').trim(),
          descricao: String(m[2] || '').replace(/\s+$/,''),
          tags: (m[3] || '').trim()
        });
      }
      return arr;
    }

    async function carregarTitulos() {
      try {
        const resp = await fetch('prompts.txt');
        if (!resp.ok) {
          console.error('Falha no fetch de prompts.txt, status', resp.status);
          return;
        }
        const texto = await resp.text();
        const itens = parseTextoPrompts(texto);

        const select = document.getElementById('tituloSelecionado');
        select.innerHTML = '<option value="">-- Escolha um título para editar --</option>';

        promptsMap = {};
        itens.forEach(({ titulo, descricao, tags }) => {
          if (!titulo) return;
          promptsMap[titulo] = { descricao, tags };
          const opt = document.createElement('option');
          opt.value = titulo;
          opt.textContent = titulo;
          select.appendChild(opt);
        });

        atualizarEstadoExcluir();

        // NOVO, aplica a pré-seleção se vier ?titulo=...
        const tituloParam = getQueryParam('titulo');
        selecionarTituloNoCombo(tituloParam);
        
      } catch (e) {
        console.error('Erro ao carregar prompts:', e);
      }
    }

    function atualizarEstadoExcluir() {
      const temTituloSelecionado = document.getElementById('tituloSelecionado').value.trim() !== '';
      document.getElementById('btnExcluir').disabled = !temTituloSelecionado;
    }

    document.getElementById('tituloSelecionado').addEventListener('change', function () {
      const titulo = this.value;
      if (promptsMap[titulo]) {
        document.getElementById('titulo').value = titulo;
        document.getElementById('descricao').value = promptsMap[titulo].descricao || '';
        document.getElementById('tags').value = promptsMap[titulo].tags || '';
      } else {
        document.getElementById('promptForm').reset();
      }
      atualizarEstadoExcluir();
    });

    document.getElementById('titulo').addEventListener('input', atualizarEstadoExcluir);

    document.getElementById('promptForm').addEventListener('submit', async function (event) {
      event.preventDefault();

      const titulo = document.getElementById('titulo').value.trim();
      const descricao = document.getElementById('descricao').value;
      const tags = document.getElementById('tags').value.trim();

      try {
        const resposta = await fetch('/add-prompt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ titulo, descricao, tags })
        });

        const mensagem = document.getElementById('mensagem');
        if (resposta.ok) {
          mensagem.textContent = '✅ Prompt salvo com sucesso';
          mensagem.className = 'text-success';
          await carregarTitulos();
          document.getElementById('tituloSelecionado').value = titulo;
          atualizarEstadoExcluir();
        } else {
          const txt = await resposta.text();
          mensagem.textContent = `❌ Erro ao salvar prompt, ${txt}`;
          mensagem.className = 'text-danger';
        }
      } catch (e) {
        console.error('Erro no POST /add-prompt:', e);
        const mensagem = document.getElementById('mensagem');
        mensagem.textContent = '❌ Erro de rede ao salvar';
        mensagem.className = 'text-danger';
      }
    });

    document.getElementById('btnExcluir').addEventListener('click', async function () {
      const tituloSel = document.getElementById('tituloSelecionado').value.trim()
                        || document.getElementById('titulo').value.trim();

      if (!tituloSel) {
        alert('Selecione um título para excluir');
        return;
      }

      const ok = confirm(`Confirmar exclusão do prompt: "${tituloSel}"?`);
      if (!ok) return;

      try {
        const resp = await fetch('/delete-prompt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ titulo: tituloSel })
        });

        const mensagem = document.getElementById('mensagem');
        if (resp.ok) {
          mensagem.textContent = '✅ Prompt excluído com sucesso';
          mensagem.className = 'text-success';
          await carregarTitulos();
          document.getElementById('promptForm').reset();
          document.getElementById('tituloSelecionado').value = '';
          atualizarEstadoExcluir();
        } else {
          const txt = await resp.text();
          mensagem.textContent = `❌ Erro ao excluir, ${txt}`;
          mensagem.className = 'text-danger';
        }
      } catch (e) {
        console.error('Erro ao excluir:', e);
        const mensagem = document.getElementById('mensagem');
        mensagem.textContent = '❌ Erro de rede ao excluir';
        mensagem.className = 'text-danger';
      }
    });

    carregarTitulos();
  </script>
</body>
</html>
